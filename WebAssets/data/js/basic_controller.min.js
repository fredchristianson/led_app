class Logger{constructor(){this.debugElement=document.getElementById("debug-messages")}write(t){console.log(t);const e=document.createElement("pre");e.innerHTML=t,this.debugElement.appendChild(e)}debug(t){}error(t){this.write(t)}}class LedSelector{constructor(t){this.count=0,this.container=document.getElementById("leds"),this.app=t,this.selected=[]}setCount(t){const e=this.container.querySelectorAll(".led");e.forEach(e=>{e.dataset.index>t&&this.container.removeChild(e)});for(var s=this.count;s<t;s++){const t=document.createElement("span");t.className="led",t.dataset.index=s,s%10==0&&(t.className="led big",t.innerText=""+s),t.style.backgroundColor="#000000",t.dataset.color="#000000",this.container.appendChild(t)}this.count=t}getCount(){return this.count}setSelection(t,e){t=Number.isNaN(t)?9999:t,e=Number.isNaN(e)?-1:e,this.selected=[];const s=this.container.querySelectorAll(".led");s.forEach(s=>{null==t||null==e||1*s.dataset.index<1*t||1*s.dataset.index>1*e?this.app.removeClass(s,"selected"):(this.app.addClass(s,"selected"),this.selected.push(s))})}rotate(){const t=this.container.querySelectorAll(".led");var e=t[t.length-1],s=e.dataset.color;t.forEach(t=>{var e=t.dataset.color;t.dataset.color=s,t.style.backgroundColor=s,s=e})}setSelectionColor(t){this.selected.forEach(e=>{e.style.backgroundColor=t,e.dataset.color=t})}setColorAtIndex(t,e){const s=this.container.querySelectorAll(".led");if(s[t]){const n=e;s[t].style.backgroundColor=n,s[t].dataset.color=n}this.selected.forEach(t=>{t.style.backgroundColor=e,t.dataset.color=e})}getRGBColors(){const t=this.container.querySelectorAll(".led"),e=[];return t.forEach(t=>{const s=t.dataset.color||"#000000",n=parseInt(s.substr(1,2),16),i=parseInt(s.substr(3,2),16),l=parseInt(s.substr(5,2),16);e.push({r:n,g:i,b:l})}),e}}class BasicControllerApp{constructor(){this.logger=new Logger,this.logger.debug("BasicControllerApp running"),this.ledSelector=new LedSelector(this),document.body.addEventListener("change",t=>{this.handleChange(t)},!0),document.body.addEventListener("click",t=>{this.handleClick(t)},!0),this.xhrOpen=!1,this.initialize()}d2h(t){const e=t.toString(16);return 1==e.length?"0"+e:e}toHexColor(t){const e=`#${this.d2h(t.r)}${this.d2h(t.g)}${this.d2h(t.b)}`;return e}async initialize(){const t=await this.get("config");if(t&&t.result){const e=t.data;this.setValue("#pin1",e.pins[0].status),this.setValue("#pin2",e.pins[1].status),this.setValue("#pin3",e.pins[2].status),this.setValue("#pin1-count",e.pins[0].count),this.setValue("#pin2-count",e.pins[1].count),this.setValue("#pin3-count",e.pins[2].count),this.setValue("#brightness",e.brightness||30)}if(this.initializeTriggers(),this.updateLedCount(),t&&t.result)for(var e=0;e<t.data.leds.length;e++){const s=this.toHexColor(t.data.leds[e]);this.ledSelector.setColorAtIndex(e,s)}}isPinActive(t){const e=document.getElementById("pin"+t);return e&&"off"!=e.value}getPinCount(t){const e=document.getElementById("pin"+t+"-count");var s=e&&e.value?1*e.value:0;return this.logger.debug("pin count "+s),s}updateLedCount(){const t=[1,2,3].reduce((t,e)=>(this.isPinActive(e)&&(t+=this.getPinCount(e)),t),0);this.logger.debug("total pins "+t),this.ledSelector.setCount(t)}getLabel(t){if(t.id)return t.id;var e=t.tagName;return t.classList&&t.classList.length>0&&(e=e+"["+Array.from(t.classList).join(" ")+"]"),e}hasClass(t,e){return t&&t.classList&&t.classList.contains(e)}initializeTriggers(){const t=document.querySelectorAll(".trigger");t.forEach((t,e)=>{this.hasClass(t,"trigger-show")&&this.triggerShow(t)},this)}getNodes(t){if(null==t)return[];if(Array.isArray(t))return t;if(t instanceof HTMLElement)return[t];if("string"==typeof t){const e=document.querySelectorAll(t);return Array.from(e)}return[]}removeClass(t,e){this.getNodes(t).forEach(t=>{t.classList.remove(e)})}addClass(t,e){this.getNodes(t).forEach(t=>{t.classList.add(e)})}setHandled(t){t.preventDefault(),t.stopPropagation()}setValue(t,e){const s=document.querySelectorAll(t);s.forEach(t=>{t.value=null===e||""===e?"":""+e})}getValue(t,e){const s=document.querySelectorAll(t);return s&&s.length>0?s[0].value:""}getIntValue(t,e=30){var s=this.getValue(t);if(null==s||""==s)return e;var n=Number.parseInt(s);return isNaN(n)?e:n}setSelection(t,e){this.setValue("#first-led",t),this.setValue("#last-led",e),this.ledSelector.setSelection(t,e)}handleClick(t){const e=t.target;if(this.logger.debug("click "+this.getLabel(e)),this.hasClass(e,"tab")&&(this.removeClass(".tabs .tab","active"),this.removeClass(".pages .page","active"),this.addClass(e,"active"),this.addClass(e.dataset.page,"active"),this.setHandled(t)),this.hasClass(e,"select-all")){const e=this.ledSelector.getCount();this.setSelection(0,e-1),this.setHandled(t)}else this.hasClass(e,"select-none")&&(this.setSelection(null,null),this.setHandled(t));if("save-leds"==e.id&&this.saveLeds(),"update-leds"==e.id&&this.sendColors(),"animate-leds"==e.id&&this.startAnimate(),"animate-stop"==e.id&&this.stopAnimate(),"clear-messages"==e.id){const t=document.querySelectorAll(".debug pre");t.forEach(t=>{t.remove()})}}startAnimate(){var t=1*this.getValue("#animate-speed");(Number.isNaN(t)||t<1)&&(t=100),this.stopAnimate(),this.interval=setInterval(()=>{this.sendColors()&&this.ledSelector.rotate(1)},t)}stopAnimate(){this.interval&&(clearInterval(this.interval),this.interval=null)}handleChange(t){const e=t.target;if(this.logger.debug("change "+t.target.id),e.classList&&e.classList.contains("trigger-show")&&this.triggerShow(e),(this.hasClass(e,"pin-count")||this.hasClass(e,"pin-status"))&&this.updateLedCount(),"led-color"==e.name){const t=e.value;this.ledSelector.setSelectionColor(t)}"first"!=e.name&&"last"!=e.name||this.ledSelector.setSelection(this.getValue("#first-led"),this.getValue("#last-led"))}triggerShow(t){if(null==t)return void this.logger.error("null trigger");"SELECT"==t.tagName&&(t=t.options[t.selectedIndex]);const e=t.dataset.hide;this.hide(e);const s=t.dataset.show;this.show(s)}show(t){if(null==t)return;const e=document.querySelectorAll(t);e.forEach(t=>{t.style.display=t.dataset.displayType||"block"})}hide(t){if(null==t)return;const e=document.querySelectorAll(t);e.forEach(t=>{t.style.display="none"})}saveLeds(){const t={brightness:this.getIntValue("#brightness",50),pins:[{status:this.getValue("#pin1"),count:this.getIntValue("#pin1-count")},{status:this.getValue("#pin2"),count:this.getIntValue("#pin2-count")},{status:this.getValue("#pin3"),count:this.getIntValue("#pin3-count")}],leds:this.ledSelector.getRGBColors()};this.logger.debug("JSON "+JSON.stringify(t,null,2)),this.post("config",t)}sendColors(){const t={brightness:this.getIntValue("#brightness",50),pins:[{status:this.getValue("#pin1"),count:this.getIntValue("#pin1-count")},{status:this.getValue("#pin2"),count:this.getIntValue("#pin2-count")},{status:this.getValue("#pin3"),count:this.getIntValue("#pin3-count")}],leds:this.ledSelector.getRGBColors()};return this.logger.debug("JSON "+JSON.stringify(t,null,2)),this.post("colors",t)}get(t){return new Promise((e,s)=>{const n=new XMLHttpRequest;n.onload=(t=>{const s=n.responseText,i=JSON.parse(s);e(i)}),n.onerror=(t=>{s(n.response)});const i="/api/"+t;n.open("GET",i),n.send()})}post(t,e){if(this.xhrOpen)return this.logger.error("too fast"),null==this.resetTimeout&&(this.resetTimeout=setTimeout(()=>{this.resetTimeout=null,this.xhrOpen=!1},5e3)),!1;this.xhrOpen=!0;const s=new XMLHttpRequest,n="/api/"+t;s.headerData.append("Accept","*"),s.headerData.append("Access-Control-Allow","*"),s.headerData.append("Content-Type","text/plain"),s.headerData.append("Access-Control-Allow-Origin","*"),s.headerData.append("Access-Control-Allow-Methods","GET,HEAD,OPTIONS,POST,PUT"),s.headerData.append("Access-Control-Allow-Headers","*"),s.open("POST",n,!0),s.onreadystatechange=(()=>{s.readyState==XMLHttpRequest.DONE&&(this.xhrOpen=!1)}),s.setRequestHeader("Content-Type","text/plain");const i=JSON.stringify(e);return s.send(i),!0}}export default BasicControllerApp;